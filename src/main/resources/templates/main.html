<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>그래픽카드 시세 차트</title>
    <meta name="description" content="최신 그래픽카드의 시세 변동을 보여주는 차트와 분석">
    <meta name="keywords" content="그래픽카드, 시세, 차트, 가격 변동, 컴퓨터 하드웨어">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f8f8;
        }
    
        #chart {
            width: 80%;
            max-width: 1000px;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            margin: 20px auto;
            /* 중앙 정렬 */
        }
    
        .chart-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 10px 0;
        }
    
        .chart-container:nth-child(odd) {
            background-color: #fff;
        }
    
        .chart-container:nth-child(even) {
            background-color: #eee;
        }
    
        .chart-container .name {
            flex: 1;
            padding: 0 10px;
        }
    
        .chart-container .bar {
            flex: 2;
            height: 20px;
            position: relative;
            /* 기본 바 배경 */
            border-radius: 5px;
        }
    
        .chart-container .bar span {
            display: block;
            height: 100%;
            border-radius: 5px;
            line-height: 20px;
            /* 세로 중앙 정렬을 위함 */
            color: white;
            /* 바 안의 텍스트 색상 */
            text-align: center;
            /* 텍스트 중앙 정렬 */
        }
    
        .chart-container .price {
            flex: 0.5;
            text-align: right;
            padding-right: 10px;
        }
    
        @media (max-width: 600px) {
            .chart-container {
                flex-direction: column;
                align-items: flex-start;
            }
    
            .chart-container .name,
            .chart-container .bar,
            .chart-container .price {
                width: 100%;
            }
        }
    </style>
</head>
<body>
<div class="container mt-5">
    <h1 class="text-center mb-4">그래픽카드 시세 차트</h1>
    <p>이 페이지에서는 최근 몇 달간 그래픽카드의 시세 변동을 보여주는 차트를 제공합니다. 각 월별로 그래픽카드의 평균 가격을 확인할 수 있으며, 시장 동향에 따른 변화를 분석할 수 있습니다.</p>

    <!-- 타임리프를 사용한 드롭다운 메뉴 -->
    <div class="mb-3">
        <label for="vgaSelect" class="form-label">그래픽카드 선택:</label>
        <select class="form-select" id="vgaSelect" name="vgaId" onchange="updateChartWithVga()">
            <option th:each="vga : ${vgaNames}" th:value="${vga.id}" th:text="${vga.vgaName}">그래픽카드 이름</option>
        </select>
    </div>

    <!-- 시간 범위 선택 버튼 -->
    <div class="btn-group" role="group" aria-label="Time options">
        <button type="button" class="btn btn-secondary" onclick="updateChartForPeriod('1week')">1주일</button>
        <button type="button" class="btn btn-secondary" onclick="updateChartForPeriod('1month')">1개월</button>
        <button type="button" class="btn btn-secondary" onclick="updateChartForPeriod('1year')">1년</button>
    </div>

    <div class="card">
        <div class="card-body">
            <canvas id="graphicsCardChart" alt="그래픽카드 가격 변동 차트"></canvas>
        </div>
    </div>
</div>
<script th:inline="javascript">
    var vgaPricesForWeek = [[${vgaPricesForWeek}]];
    var vgaPricesForMonth = [[${vgaPricesForMonth}]];
    var vgaPricesForYear = [[${vgaPricesForYear}]];

    console.log(vgaPricesForMonth);
    console.log(vgaPricesForWeek);

    // 페이지 로드 시 선택된 그래픽카드를 설정하는 함수
    function setSelectedVgaFromUrl() {
        var urlParams = new URLSearchParams(window.location.search);
        var selectedVgaId = urlParams.get('vgaId');
        if (selectedVgaId) {
            document.getElementById('vgaSelect').value = selectedVgaId;
        }
    }

    // 특정 그래픽카드를 선택하면 페이지 이동
    function updateChartWithVga() {
        var selectedVga = document.getElementById('vgaSelect').value;

        // 페이지 URL 업데이트 (예: /graphicsCard?vgaid=selectedVga)
        window.location.href = '/?vgaId=' + selectedVga;
    }

    // 날짜 포맷 함수
    function formatDate(dateString) {
        var date = new Date(dateString);
        return date.getFullYear() + '-' + (date.getMonth() + 1) + '-' + date.getDate();
    }

    // 차트 데이터를 업데이트하기 위한 함수
    function updateChartData(data) {
        var labels = data.map(item => formatDate(item.date));
        var prices = data.map(item => item.vgaPrice);
        return { labels, prices };
    }

    // 차트 업데이트 함수
    function updateChart(data) {
        var chartData = updateChartData(data);
        chart.data.labels = chartData.labels;
        chart.data.datasets[0].data = chartData.prices;
        chart.update();
    }

    // 시간 범위에 따른 차트 업데이트
    function updateChartForPeriod(period) {
        if (period === '1week') {
            updateChart(vgaPricesForWeek);
        } else if (period === '1month') {
            updateChart(vgaPricesForMonth);
        } else if (period === '1year') {
            updateChart(vgaPricesForYear);
        }
    }

    // 차트 초기화
    var ctx = document.getElementById('graphicsCardChart').getContext('2d');
    var chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: '그래픽카드 가격',
                backgroundColor: 'rgba(0, 123, 255, 0.5)',
                borderColor: 'rgba(0, 123, 255, 1)',
                data: []
            }]
        },
        options: {}
    });

    // 페이지 로드 시 실행
    document.addEventListener('DOMContentLoaded', function() {
        setSelectedVgaFromUrl();
        updateChartForPeriod('1month');
    });
</script>
<div id="chart">
    <div th:each="data : ${videoCardData}">
        <div class="chart-container">
            <div class="name" th:text="${data.vgaName}"></div>
            <!-- 'value' 필드를 사용한 바 차트 -->
            <div class="bar">
                <span th:style="'width: ' + (${data.value} / 100) * 100 + '%';"></span>
            </div>
            <div class="price" th:text="${data.vgaPrice ? '$' + ${data.vgaPrice.toFixed(2)} : 'NA'}"></div>
            <!-- 카테고리 표시 -->
            <div class="category" th:text="${data.CAT == 0 ? 'NVIDIA' : 'AMD'}"></div>
        </div>
    </div>
</div>
<div>
    <input type="radio" name="category" value="NVIDIA" id="nvidia-radio" checked>
    <label for="nvidia-radio">NVIDIA</label>
    <input type="radio" name="category" value="AMD" id="amd-radio">
    <label for="amd-radio">AMD</label>
</div>

<script>
    // 초기 차트 생성
    updateChart();

    // 라디오 버튼 이벤트 처리
    const radioButtons = document.querySelectorAll('input[name="category"]');
    radioButtons.forEach(radioButton => {
        radioButton.addEventListener('change', updateChart);
    });

    // 차트 업데이트 함수
    function updateChart() {
        const selectedCategory = document.querySelector('input[name="category"]:checked').value;
        const chart = d3.select("#chart");
        chart.html(""); // 기존 차트 내용 삭제

        // DOM에서 데이터 읽기
        document.querySelectorAll(".chart-container").forEach(container => {
            const name = container.querySelector(".name").textContent;
            const value = parseFloat(container.querySelector(".bar span").style.width);
            const price = container.querySelector(".price").textContent;
            const category = container.querySelector(".category").textContent;

            if (category === selectedCategory) {
                // 여기에 차트에 데이터를 추가하는 로직
            }
        });
    }
</script>
</body>
</html>
